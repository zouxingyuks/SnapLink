## 部署文档

### 1. 准备原始配置文件

> 由于目前 docker compose 的长久功能缺失，导致我们还是需要手动复制配置文件

 

```
docker run -d \
  --name snaplink-rabbitmq \
  -p 5672:5672 \
  -p 15672:15672 \
  -e RABBITMQ_DEFAULT_USER=admin \
  -e RABBITMQ_DEFAULT_PASS=password.123 \
  -v $(pwd)/docker_data/snaplink/rabbitmq:/var/lib/rabbitmq \
  --hostname snaplink-rabbitmq \
  --network snaplink_net \
  rabbitmq:latest

docker run -d \
  --name snaplink-mysql \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD="pjJdE#j:ovE-J:Vk1~?y" \
  -e MYSQL_DATABASE=saas \
  -e MYSQL_USER=saas \
  -e MYSQL_PASSWORD="vAm>~,A*Cdo9j#6@^*k3" \
  -v $(pwd)/docker_data/snaplink/mysql/conf:/etc/mysql/mysql.conf.d \
  -v $(pwd)/docker_data/snaplink/mysql/log:/var/log/mysql \
  -v $(pwd)/docker_data/snaplink/mysql/data:/var/lib/mysql \
  --network snaplink_net \
  mysql:latest
  
docker run -d \
  --name snaplink-redis \
  -p 6379:6379 \
  -p 8001:8001 \
  --network snaplink_net \
  redis/redis-stack-server

docker run -d \
  --name snaplink-maxwell \
  --hostname snaplink-maxwell \
  -v $(pwd)/docker_data/snaplink/maxwell:/etc/maxwell/ \
  --network snaplink_net \
  zendesk/maxwell \
  bin/maxwell --config /etc/maxwell/config.properties

docker network create snaplink_net

# 对于RabbitMQ
docker cp snaplink-rabbitmq:/var/lib/rabbitmq $(pwd)/docker_data/rabbitmq

# 对于MySQL
docker cp snaplink-mysql:/etc/mysql/mysql.conf.d $(pwd)/docker_data/mysql/conf
docker cp snaplink-mysql:/var/lib/mysql $(pwd)/docker_data/mysql/data

# 对于Maxwell
docker cp snaplink-maxwell:/etc/maxwell/ $(pwd)/docker_data/maxwell

# 停止并删除RabbitMQ容器
docker stop snaplink-rabbitmq
docker rm snaplink-rabbitmq

# 停止并删除MySQL容器
docker stop snaplink-mysql
docker rm snaplink-mysql

# 停止并删除Maxwell容器
docker stop snaplink-maxwell
docker rm snaplink-maxwell

```



### 1. 启动 docker 环境并进行基本配置

```bash
docker compose up -d
```

#### MySQL 配置

进入 `./docker_data/mysql` 文件夹

修改文件`my.cnf`

```
# 配置文件中添加如下内容，注意是在 [mysqld] 下方
[mysqld]
log-bin=mysql-bin  # 开启 binlog
binlog-format=ROW  # 选择 ROW 模式
server-id=1 # 配置 MySQL replaction 需要定义，不要和 maxwell 的 slaveId 重复
```

而后重启 MySQL 的容器。

使用命令`docker exec -it snaplink-mysql bash` 进入 docker 控制台

```mysql
mysql -u root -p
```

默认 root 密码为：`pjJdE#j:ovE-J:Vk1~?y`

使用`show variables like 'log%'; ` 查看配置

正确配置如下图所示：![](https://cimg.anubis.cafe/2024/04/2ffa1b8b9194a43e4b7049900ae0d1a2.webp)



查看

接下来配置 maxwell 所需的账户

```sql
CREATE DATABASE maxwell;
-- 创建用户 maxwell
CREATE USER 'maxwell' IDENTIFIED BY 'maxwell';

GRANT SELECT, REPLICATION CLIENT, REPLICATION SLAVE on *.* to 'maxwell';
GRANT ALL ON maxwell.* TO 'maxwell'@'%';
FLUSH PRIVILEGES;

```

> 此处因需要考虑到创建时 ip 的变化，对账户并没有做 ip 限制





#### RabbitMQ 配置

使用命令`docker exec -it snaplink-rabbitmq bash` 进入 docker 控制台

输入下列命令启用控制台：

```bash
rabbitmq-plugins enable rabbitmq_management
```

![](https://cimg.anubis.cafe/2024/04/1450c6ea4ef2e254b2b7cde6e16602c0.webp)

进入[控制台](http://localhost:15672/)，初始账户为

```
username: admin
password: password.123
```

创建 vHost,起名为 maxwell

![](https://cimg.anubis.cafe/2024/04/8bb29b59891fdb65263bb08036d14f69.webp)

创建用户

```
maxwell
maxwell
```

![](https://cimg.anubis.cafe/2024/04/2908bdf3cdbb7f72f6669a08e2ec948b.webp)

给用户赋予 maxwell 这个 vHost 的访问权限

![](https://cimg.anubis.cafe/2024/04/5fcb5c8ac02036b48c06859fe12eb86b.webp)

#### Maxwell 配置

> 此处配置需要在前两个配置完成后才可以配置

在 `./docker_data/maxwell` 文件夹中创建`config.properties`

```
# tl;dr 配置
log_level=DEBUG

producer=rabbitmq


# mysql 登录信息
host=snaplink-mysql
port=3306
user=maxwell
password=maxwell

# rabbitmq 配置信息
rabbitmq_host=snaplink-rabbitmq
rabbitmq_port=5672
#此处填写前面创建的 rabbitmq 用户
rabbitmq_user=maxwell
rabbitmq_pass=maxwell
rabbitmq_virtual_host=maxwell
rabbitmq_exchange=maxwell.topic
rabbitmq_exchange_type=topic
rabbitmq_routing_key_template=%db%.%table%

#     *** 通用配置 ***
# 选择数据输出目的地。支持 stdout|file|kafka|kinesis|pubsub|sqs|rabbitmq|redis|bigquery
#producer=kafka

# 设置日志级别。注意，你可以在 log4j2.xml 中进一步配置
#log_level=DEBUG # [DEBUG, INFO, WARN, ERROR]

# 如果设置，maxwell 会查找限定环境变量，去掉前缀并注入配置
#env_config_prefix=MAXWELL_

#     *** MySQL 配置 ***

# 要连接的 MySQL 主机
#host=hostname

# 要连接的 MySQL 端口
#port=3306

# MySQL 用户名。此用户必须拥有 REPLICATION SLAVE 权限，
# 以及对 `maxwell`（或 schema_database）数据库的完全访问权限
#user=maxwell

# MySQL 密码
#password=maxwell

# 传递给 jdbc 连接的选项，格式为 opt=val&opt2=val2
#jdbc_options=opt1=100&opt2=hello

# maxwell 保存其状态的 MySQL 数据库名称
#schema_database=maxwell

# 是否使用 GTID 进行定位
#gtid_mode=true

# maxwell 会捕获一个初始的“基础”架构，包含所有表和列信息，
# 然后在该架构上保持增量更新。如果你有过多的 DDL 变更，
# 包含增量变更的表会随时间无限制增长（可能变得过大）。如果启用此选项，
# Maxwell 会定期压缩其表。
#max_schemas=10000

# SSL/TLS 选项
# 使用 VERIFY_CA 或 VERIFY_IDENTITY 时，必须使用 Java opts 设置信任库：
#   -Djavax.net.ssl.trustStore=<truststore> -Djavax.net.ssl.trustStorePassword=<password>
# 或将 MySQL 证书导入全局 Java cacerts。
# MODE 必须是 DISABLED, PREFERRED, REQUIRED, VERIFY_CA, 或 VERIFY_IDENTITY 其中之一
#
# 开启 maxwell-store 连接的 ssl，其他连接继承此设置，除非另有指定
#ssl=DISABLED
# 对于 binlog-connector
#replication_ssl=DISABLED
# 对于 schema-capture 连接，如果使用
#schema_ssl=DISABLED

# maxwell 可以选择性地从不同于存储
# schema 和 binlog 位置信息的服务器复制。在这里指定那个不同的服务器：

#replication_host=other
#replication_user=username
#replication_password=password
#replication_port=3306

# 当使用 MaxScale 的 binlog 镜像主机时可能有用。
# 指定 Maxwell 应该从与它复制的不同服务器捕获 schema：

#schema_host=other
#schema_user=username
#schema_password=password
#schema_port=3306


#       *** 输出格式 ***

# 记录是否包括 binlog 位置（默认为 false）
#output_binlog_position=true

# 记录是否包含 gtid 字符串（默认为 false）
#output_gtid_position=true

# 记录是否包括具有 null 值的字段（默认为 true）。如果为 false，
# 值为 null 的字段将完全从输出中省略。
#output_nulls=true

# 记录是否包括 server_id（默认为 false）
#output_server_id=true

# 记录是否包括 thread_id（默认为 false）
#output_thread_id=true

# 记录是否包括 schema_id（默认为 false）
#output_schema_id=true

# 记录是否包括 row query，必须启用 binlog 选项 "binlog_rows_query_log_events"（默认为 false）
#output_row_query=true

# DML 记录是否包含组成行主键的值列表（默认为 false）
#output_primary_keys=true

# DML 记录是否包含组成行主键的列列表（默认为 false）
```

配置完成后再次启动 maxwell 这个容器